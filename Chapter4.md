# Webサーバーの構築
ホームページやWebシステムを公開するためのWebサービスを設定します。パッケージのインストールやシステム管理権限、セキュリティを考慮したネットワークのアクセス制限などについても触れます。

## 用語集
### HTML(HyperText Markup Language)
Webページを書くためのタグを使って文章を構造的に記述できるマークアップ言語です。他ドキュメントへのハイパーリンクを書いたり、画像を利用したり、リストや表などの高度な表現も可能です。現在では、ページレイアウトなどを定義するCSS（Cascading Style Sheets）や、プログラムを記述できるJavaScriptなどと組み合わせて高度なWebページを作成できます。

### HTTP(HyperText Transfer Protocol)
WebブラウザーとWebサーバーの間でHTMLなどのコンテンツ(データ)送受信に使われる通信手順です。ファイルのリクエスト(要求)とファイルのレスポンス(返送)が組でセッションになります。現在では、通信を暗号化などしてセキュリティを高めたHTTPS（Hypertext Transfer Protocol Secure）が使用されています。

### Apache Webサーバー
世界中でもっとも使われているWebサーバーであり、大規模な商用サイトから自宅サーバーまで幅広く利用されています。Apacheソフトウェア財団のApache HTTPサーバープロジェクトで開発が行われているオープンソースソフトウェアです。

### URL(Uniform Resource Locator)
インターネット上のリソースを指定するための記述方法で、ホームページのアドレスやメールのアドレスなどを指定できます。リソースを特定するスキーム名とアドレスを://でつないで書きます。

### パッケージ
プログラムの本体であるバイナリや設定ファイル、ドキュメントなどを一式まとめてインストール可能なようにまとめたものです。大きなプログラムの場合、本体とライブラリ、各種拡張機能などを別々のパッケージとしてまとめて選択的にインストールできるようにしていることがあります。Linuxディストリビューションは、このパッケージの集合体と考えることができます。

### システム管理権限
Linuxは複数のユーザーが同時に利用できるマルチユーザー型のOSです。システム管理権限は、システム全体に対する変更などが行える権限で、一般的なユーザーには与えられていません。Linuxではユーザーrootか、sudoコマンドを使える権限が与えられたユーザーのみシステム管理権限を行使できます。

## Webサーバーの仕組み
Webシステムとは、インターネット環境で最も代表的なクライアントサーバー型のシステムで、WebサーバーとクライアントのWebブラウザーとで構成されます。Webサーバーは要求されたファイルをWebクライアントに提供し、クライアントは受け取ったファイルを表示します。提供される情報はテキストから画像や動画と幅広く、クライアントが対応しているデータならば広く扱えます。Webシステムの文章データとしてはHTMLが一般的に使われています。WebサーバーとしてApache Webサーバーが多く使われていますが、Nginx（エンジンエックス）や各種Webアプリケーションを動作させるのに特化したWebアプリケーションサーバーなども使われています。

# パッケージのインストール
LinuxでWebサーバーを動作させるには、まずWebサーバーのインストールを行います。ソースコードをコンパイルして動かすこともできますが、パッケージを使えば簡単にインストールが行えます。使用しているAlmaLinuxではRPM形式のパッケージを使用しており、パッケージ管理ツールとしてdnfコマンドが使用できます。

## dnfコマンド
dnfコマンドを使うと、パッケージのインストールや削除、アップデートなどが行えます。

### sudoコマンドによるroot権限の取得
dnfコマンドによるパッケージのインストールは、システムの変更を伴うため管理者であるrootの権限が必要になります。コマンド実行時にroot権限を取得するには、sudoコマンドを使用します。OSインストール時、あるいは初期設定時に作成したユーザーにはsudoコマンドを実行する権限が与えられています。

### dnfコマンドが参照するパッケージリポジトリ
dnfコマンドは、インストールに使用するパッケージをリポジトリと呼ばれる場所から取得します。通常はインターネット上にリポジトリサーバーが用意されており、インターネット経由でパッケージをダウンロードします。今回はインターネットにアクセスできる前提で作業を行います。
インターネットへのアクセスにプロキシーを経由する必要がある場合、dnfコマンドの設定でプロキシーを設定することでアクセスできるようになります。設定方法はマニュアル等を参照してください。

### インターネットにアクセスできない環境でのパッケージ管理
インターネットにアクセスできない環境ではインターネット上のリポジトリにアクセスできないため、以下のような方法でインストールを行う必要がありますが、ここでは詳細には触れません。

・OSインストール時にあらかじめ必要なソフトウェアを選択してインストールしておく
・インストールに使用したISOイメージに含まれているパッケージファイルをrpmコマンドを使って手動でインストールする
・ISOイメージをリポジトリとして扱うように設定ファイルを作成する
・アクセス可能なローカルネットワーク上にリポジトリサーバーを用意する

ただし、これらの方法ではセキュリティアップデートなどが行われた最新のパッケージをインストールするのが難しくなります。

### 依存関係の解消
動作するために複数のパッケージが必要となる場合、dnfコマンドはインストールするパッケージが必要とするパッケージも同時にインストールを行います。必要となるパッケージがあることを依存関係と呼びます。dnfコマンドは依存関係を自動的に解消し、必要となるすべてのパッケージをまとめてインストールします。

## dnf installコマンドによるパッケージのインストール
Apache Webサーバーのパッケージ名はhttpdです。インストールするには、sudoコマンドを頭に付けてdnf installコマンドを実行します。

sudo dnf install httpd

sudoコマンドを初めて実行する際には、実行しているユーザーのパスワードが要求されます。sudoコマンド実行後、しばらくの間は再度実行する際にはパスワードが要求されませんが、一定時間経過後は再度要求されます。
dnfコマンドはリポジトリにアクセスし、新たに利用可能になったパッケージのリストを取得してパッケージデータベースを更新します。
インストールを行うhttpdパッケージの依存関係を確認し、必要となる追加のパッケージも同時にインストールを行います。実行例では、依存関係にある7つのパッケージ、弱い依存関係にある3つのパッケージの合計10のパッケージも追加でインストールすることを提案しています。問題なければ y を入力してパッケージのダウンロードとインストールを行います。

### httpdのdについて
dはDaemonの頭文字です。Daemonは悪魔を指すDemonではなく、ギリシャ神話の半神半人を指します。バックグラウンドで動作して各種サービスを提供するようなプログラムのことをDaemonと呼びます。

# Webサーバーの起動
Web サーバーを起動します。systemctlコマンドを使って、Webサーバーをバックグラウンドサービスとして起動します。

## systemctlコマンド
systemctlコマンドはsystemdを制御するためのコマンドです。systemdはLinuxがOSとして起動する際、Linuxカーネルが起動した後に一番最初に実行されるプロセスで、OS全体を制御します。
systemctlコマンドは管理対象をユニットという単位で管理します。

## Webサーバーの起動
Webサーバーを起動するには、systemctl startコマンドを実行します。systemdはWebサーバーをhttpd.serviceユニットとして管理しています。ユニット名の.serviceは省略形の名称が重複していない限り省略できます。

sudo systemctl start httpd

エラーなどが発生しなければ、systemctl startコマンドの実行は何も表示されず終了します。

# Webサーバーの動作確認
Webサーバーが正しくバックグラウンドサービスとして実行されているかを確認します。システム的に確認する方法と、Webサーバーとして動作していることの確認の両方を実行します。

## systemctl statusコマンドによる動作状態の確認
systemctl statusコマンドで、管理対象となるユニットの状態やログの一部などを確認できます。

sudo systemctl status httpd

Loaded
ユニットの設定がsystemdに読み込まれているかどうか。ユニットの定義ファイルの位置や、自動起動の設定がされているかが確認できる。

Active
現在、ユニットがアクティブかどうか。また、プロセスが動作しているかどうかが確認できる。

その他、プロセスに関わる情報などが表示されており、起動していることがわかります。

## curlコマンドによる接続確認
Webサーバーとして動作していることを確認します。curlコマンドを実行して、自分自分を指すlocalhostに接続してみます。

curl localhost

Webサーバーとして実行されているので、サンプルページのHTMLが返ってきます。

## ゲストOSのWebブラウザによる接続確認
仮想マシンのGUIを使ってWebブラウザを実行し、Webサーバーにアクセスしてみます。
画面左上の「アクティビティ」をクリック
画面下に並んでいるアイコンから、一番左のFirefoxを実行
アドレスにlocalhostを入力

Webブラウザの要求に対して、WebサーバーがHTMLを返し、WebブラウザがそのHTMLを解釈してWebページを表示しているのが分かります。右下にはHTMLが要求したことで追加で取得した画像ファイルも埋め込まれています。1つのWebページを表示するのに、Webブラウザの裏側で複数のセッションがやり取りされて画像ファイルなどが取得されていることが分かります。

## ホストOSのWebブラウザによる接続確認
ホストOS上でWebブラウザを実行し、ゲストOS上のWebサーバーにアクセスしてみます。
同一の物理マシンですが、論理的には別々のOS、別々のIPアドレスを持っており、ネットワークを経由してリモートにあるWebサーバーにアクセスしていることになります。

### ファイアーウォールの設定を変更してHTTPアクセスを許可する
セキュリティを強化するため、Linuxはデフォルトでは必要最低限のネットワーク通信しか受け付けないようにファイアウォールが設定されています。WebサーバーにアクセスするHTTPは許可されていないので、firewall-cmdコマンドでHTTPでのアクセスを許可します。

まず、現在のファイアーウォールの設定を確認します。

sudo firewall-cmd --list-all

services行にhttpが含まれていないので、アクセスが許可されていません。

ホストOSでWebブラウザを実行し、以下のアドレスにアクセスします。

http://192.168.56.101

Webサーバーからの結果を待ち続けており、テストページは表示されません。Webサーバーは動作していますが、ファイアウォールが手前で遮っているためWebサーバーに到達できないためです。そのまま待っていると、Webブラウザがタイムアウトしてエラーが表示されます。

以下のコマンドでアクセスを許可します。

sudo firewall-cmd --add-service=http --zone=public

再度ファイアーウォールの設定を確認します。

sudo firewall-cmd --list-all

services行にhttpが追加され、アクセスが許可されました。

再度、ホストOS上のWebブラウザから以下のアドレスにアクセスします。

http://192.168.56.101

テストページが表示されたら、無事にWebサーバーにアクセスできています。

# Webサーバーの停止
Webサーバーを停止してみます。停止にはsystelctl stopコマンドを実行します。

sudo systemctl stop httpd

## systemctlコマンドによる動作状態の確認
systemctl statusコマンドを実行して、動作状態を確認します。

sudo systemctl status httpd

Active行が inactive (dead)になっており、プロセス関係の情報が表示されなくなり、Webサーバーが停止しているのが分かります。

## curlコマンドによる接続確認
Webサーバーが停止している状態で、curlコマンドを実行してみます。

curl localhost

即座にエラーが表示されて、Webサーバーにアクセスできないのが分かります。

## ゲストOSのWebブラウザによる接続確認
ゲストOSのWebブラウザでアクセスしてみます。

localhost

即座にエラーが表示されて、Webサーバーにアクセスできないのが分かります。

## ホストOSのWebブラウザによる接続確認
ホストOSのWebブラウザでアクセスしてみます。

http://192.168.56.101

即座にエラーが表示されて、Webサーバーにアクセスできないのが分かります。ファイアウォールに遮られてアクセスできない場合にはタイムアウトするまでエラーが表示されないのと比較して、Webサーバーにアクセスできない理由によって動作が異なる点に注目してください。

## Webサーバーを再度起動
Webサーバーを再度起動し、それぞれの方法で正常にアクセスできるように復旧したことを確認してください。

sudo systemctl start httpd

# ログの確認
Webサーバーへのアクセスや発生したエラーはログファイルに記録されています。アクセスログはどのような人が、どのようなページにアクセスしているかの分析に、エラーログは発生した障害の解決に利用されます。それぞれ、どのような情報が記録されているか確認してみましょう。

## Webサーバーのログファイルの確認
Webサーバーのログは/var/log/httpdディレクトリに記録されています。このディレクトリの中にあるファイルを確認するには、管理者権限が必要です。

sudo ls /var/log/httpd

access_logとerror_logの2つのログファイルが確認できます。

## アクセスログの確認
アクセスログに記録されている内容を確認します。

sudo cat /var/log/httpd/access_log

アクセスログには、以下のような情報が記録されています。

アクセス元のIPアドレス
アクセスした時間
アクセスの内容
アクセスの結果（エラー番号）
アクセスした際に入力されたURL
アクセスに利用されたブラウザの種類

### エラー番号
アクセスログの中で分かりにくいのが、アクセスの結果を示すエラー番号です。エラー番号は様々な種類が定義されていますが、現時点で記録されているのは主に以下の2つです。

200
アクセスが成功した。

404
アクセスしたファイルなどが見つからず失敗した。

この2つ以外にも、304や403などが記録されている場合があります。

## エラーログの確認
エラーログに記録されている内容を確認します。

sudo cat /var/log/httpd/error_log

エラーログには、Webサーバーの起動や停止の際に出力されたログや、アクセスログにも記録されているエラーの詳細などが記録されています。
エラーログの中に以下のようなエラーがあります。


これは、/var/www/htmlディレクトリにindex.htmlが存在しない、というエラーです。実はテストページとして表示されていたのは、エラー404が発生した時にWebサーバーが返すHTMLの内容がテストページのように見えていただけで、実際には必要なファイルが見つからないエラーが発生していたわけです。このエラーを解決してみましょう。

# index.htmlを配置する
Webサーバーは、Webブラウザからのリクエストに応じて表示するHTMLファイルなどを/var/www/htmlディレクトリ以下に配置するように設定されています。現時点ではこのディレクトリには何も配置されていないため、404エラーが発生していました。このエラーを解消するため、index.htmlを作成してみます。index.htmlは、Webブラウザがファイル名を指定しなかった場合にデフォルトで参照されるHTMLファイルの名前です。

以下のコマンドを実行して、/var/www/htmlディレクトリにindex.htmlファイルを作成します。

sudo sh -c "echo 'Hello,World' > /var/www/html/index.html"

書き込みには管理者権限が必要ですが、リダイレクトによってファイルを作成するにはコマンド全体をsudoコマンドで呼び出したsh -cコマンドで実行する必要があります。また、コマンド全体を"(ダブルクォーテーション)で囲い、書き込み文字列を'(シングルクォーテーション)で囲っています。この違いにも注意してコマンドを入力してください。

## Webブラウザからのアクセスとログの確認
Webブラウザから再度Webサーバーにアクセスしてみます。今度はテストページではなく、「Hello,World」の文字列が表示されたのではないでしょうか。
また、アクセスログにどのように記録されているか、エラーログにエラーが記録されていないことも確認してみてください。

# システム起動時のWebサーバー自動起動とファイアーウォールの設定
Webサーバーの起動や、ファイアーウォールの設定を行いましたが、これらの設定はOSを再起動すると無効になってしまいます。OSを再起動してもWebサーバーが自動的に起動し、ファイアーウォールの設定が行われてHTTPによるアクセスが可能になるように設定しましょう。

## OS再起動
まず、OSを再起動し、Webサーバーが自動起動せず、ファイアーウォールの設定が行われないことを確認します。OSを再起動するにはrebootコマンドを実行します。rebootコマンドはsudoコマンドを付けて実行しないでも実行できます。

$ reboot

## 再起動後の動作確認
Webサーバーが自動的に起動していないこと、ファイアーウォールの設定でHTTPが許可されていないことを確認します。

sudo systemctl status httpd

sudo firewall-cmd --list-all


## Webサーバーの自動起動設定
WebサーバーをOS起動時に自動的に起動するようにするにはsystemctl enableコマンドを実行します。

sudo systemctl enable httpd

## ファイアーウォールの自動設定
OS起動時にファイアウォールを自動的に設定するようにするにはfirewall-cmdに--permanentオプションを付けて実行します。

sudo firewall-cmd --add-service=http --zone=public --permanent


## OS再起動と確認
再度、OSを再起動します。再起動後、Webサーバーが自動起動していること、ファイアーウォールの設定が行われていることを確認します。


