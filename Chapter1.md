# Linuxサーバーの概要
本教科書では、Linuxをインストールし、サーバー環境を構築する実習をしながら、LPICレベル2の範囲の理解と取得を目指します。第1章では、Linuxサーバーの概要について解説し、2章以降に行う実習に必要な環境と知識の確認を行います。

## 用語集
#### Linux
Linus Torvalds氏により開発された、UNIX互換を目指したOSの総称をLinuxといいます。ソースコードは公開されており、世界中の開発者の協力により、日々開発が継続されています。

#### ディストリビューション
Linuxは狭い意味ではOSの中心部（＝カーネル）のみを指しますが、Linuxカーネルだけではシステムは動作しません。カーネル以外のさまざまなソフトウェアやインストーラを追加して、利用できるようにしたのがディストリビューションです。ディストリビューションごとに開発方針があり、それに沿ってソフトウェアがまとめられたり、リリースが行われています。

#### AlmaLinux
Linuxのディストリビューションの1つです。Red Hat Enterprise Linuxという商用のディストリビューション互換の環境を無償で提供しているディストリビューションで、AlmaLinuxコミュニティによってリリースされています。

####  ネットワークアドレス 
IPネットワークを小さく分割して利用するときに、ネットワークアドレス部とホストアドレス部に分かれます。ネットワークアドレスの識別に利用されるのが、ネットワークアドレス部です。

####  IPアドレス 
インターネットにおいて、IPで通信が行われる場合、端末一つ一つにIPアドレスが割り当てられます。IPアドレスとはインターネット上での端末の所在地を示す”住所”にあたります。

#### サブネットマスク
IPアドレスのうちネットワークアドレス部とホストアドレス部を識別するための数値のことをいいます。通常8ビット毎に.(ドット)で区切って入力されます。

####  DNSサーバーアドレス 
IPアドレスとFQDN（＝ホスト名＋ドメイン名）の変換を行うのがDNSサービスであり、そのサービスを提供するDNSサーバーのIPアドレスのことです。

#### ホスト名
ネットワークに接続されたコンピューターに割り当てられた名称のことをいいます。特定のホストを識別するために使われます。

#### ドメイン名
インターネット上に存在するコンピューターやネットワークを識別するために付けらている名前の一種のことをいいます。ドメイン名はアルファベット、数字、一部の記号の組み合わせで構成されますが、日本語.jp のような国際化ドメインも使われるようになっています。

#### DVD
光学メディアの1種類で、ビデオ再生での利用で普及し、現在ではデータ記録の用途でも利用されています。約700MBのCD-ROMに比べ、約4.7GBと大容量でも利用できることから、OSのインストールディスクとしても利用されています。

#### ハードディスク  
磁気を用いた記憶媒体であり、パソコンの記憶媒体の他、音楽プレーヤー、ビデオなどの記憶媒体としても用いられています。

#### SSD  
半導体メモリであるフラッシュメモリを用いた記憶媒体であり、ハードディスクよりも読み書きの処理性能に優れています。

#### LVM  
LVM（Logical Volume Manager）とは，複数のハードディスクやパーティションにまたがった記憶領域を一つの論理的なディスクとして扱うことのできるディスク管理の機能のことです。LinuxをはじめとしたUNIX系OS上で利用できます。

####  RAID  
複数のハードディスクをまとめて1台のハードディスクとして管理する技術のことです。
RAIDを使うことによりデータを分散して記録するため、高速化や安全性の向上が期待できます。RAIDの方法には、専用のハードウェアを使う方法（ハードウェアRAID）とソフトウェアで実現する方法（ソフトウェアRAID）があり、高速性や安全性のレベルにより、RAID 0やRAID 5などいくつかの種類があります。

## 実習で利用するハードウェア
本教科書の実習では、市販されているような一般的な構成のPCにLinuxを導入して、その環境上に様々なサーバーを導入し実際に動作させます。この実習で必要な、ハードウェアの仕様は次の通りです。

#### マシン本体  
WindowsやLinuxが動作する、いわゆる「パソコン」を想定しています。ただ、実習用のパソコンを用意することが難しい場合には、「VirtualBox」のような仮想マシンソフトウェアを利用して実習環境を用意することもできます。VirutalBoxは、次のURLからダウンロードすることができます。

```
https://www.virtualbox.org/
```

####  実装メモリ  
CentOS 7では1024MBのメモリが推奨されています。実装メモリが少ない場合はテキストインストールが実行されることがあります。

#### DVD光学ドライブ
本教科書の実習では、インストール用DVDを利用するので、光学ドライブがDVDを読み取りできる必要があります。DVDの光学ドライブがない機種では、USBドライブを利用することもできます。
また一部のノートパソコン等で、光学ドライブが無いマシンもあります。そういったときは、USB等で接続するDVDドライブを用意します。それを利用することにより、インストールDVDを起動することができます。

#### USBメモリ
最近のPCではUSBメモリからのブートもサポートしています。そのため、インストールDVDの代わりに、USBメモリを利用することができます。

#### ハードディスク  
Linuxをインストールするためには記憶装置が必要です。ここでは記憶装置としてハードディスクを使います。インストールにはハードディスクに約8GBの空き領域があれば十分なので、一般的な構成のPCでは十分満たしていると思います。
またハードディスクをフォーマット（初期化）してLinuxをインストールします。従って、ハードディスクの中身は全部消去されます。その為、ハードディスクを削除していいPCを利用するか、バックアップを取ってから作業を行ってください。

#### その他周辺機器   
本体やDVD、光学ドライブ、ハードディスクドライブの他にも、一般的に利用するためにはキーボード、マウス、ディスプレイ等の周辺機器が必要です。
キーボードは、日本語か英語かで設定が異なりますので、日本語キーボード、英語キーボードの区別を「確認シート」に記述します。

## 利用するLinuxのディストリビューション
本教科書では、CentOSのバージョン7.6、64ビット版を利用します。

``` {title="\{CentOS公式サイト\}"}
http://www.centos.org/
```
CentOSは、商用ディストリビューションであるRed Hat Enterprise Linuxの互換ディストリビューションとして提供されています。本家Red Hatとのバイナリ互換を保ちながら、サポートも同等を目指すという方針で開発されています。利用に際し費用が発生することはない、無償で提供されているディストリビューションです。

### インストールDVD/USBの入手方法
今回インストールには、DVDまたはUSBのインストーラーを利用します。CentOSのインストール用DVD、USBの入手方法には次の2通りが存在します。

#### ISOイメージをダウンロードする  
CentOSが配布しているISOイメージを、ダウンロードします。ダウンロード元のURLは以下のとおりです。CentOSの最新版の、ISOイメージのページへのリンクになっています。

``` {title="\{ダウンロードサイト\}"}
http://isoredirect.centos.org/centos/7.6.1810/isos/x86_64/
```

![CentOS7.6のダウンロードサイト](image/centosmirror.png){width=50%}

このURLをクリックすると、多くのミラーサイトが表示されます。その中でバージョン7.6のISOイメージをダウンロードします。例えば、riken（理化学研究所）が提供しているミラーサイトのURLであれば次のようになります。

``` {title="\{ダウンロードするISOイメージ\}"}
http://ftp.riken.jp/Linux/centos/7.6.1810/isos/x86_64/CentOS-7-x86_64-DVD-1810.iso
```

このDVDイメージ(CentOS-7-x86_64-DVD-1810.iso)をダウンロードします。ISOイメージは合計で4.3GBあり、転送に時間がかかります。

また、BitTorrentを使ってのダウンロードも行えます。ダウンロードサイトに.torrentという拡張子のファイル名が置かれているので、このファイルをダウンロード後、BitTorrentに対応したソフトウェアを使ってダウンロードが行えます。

ダウンロードしたISOイメージは、DVDやUSBのライティングソフトウェアを使ってDVD/USBに書き込んでください。データとしてではなく、イメージとして書き込む点に注意してください。

#### 雑誌や解説書の付録  
CentOSは雑誌に付属していたり、CentOSの解説書が多く出版されています。それらに付属しているインストールDVDを利用してもかまいません。

### バージョン
本教科書では、本教科書の作成時点で最新であったCentOS 7.6を利用した構築方法について解説しています。雑誌や解説書などの付録など、入手の方法によっては7.6ではない、より新しいバージョンのCentOSを手にすることがあるかもしれません。しかし、バージョン7.x系であれば大きな差は無いようです。従ってCentOSの7.x系であれば、同様の手順でサーバーの構築ができるようになっています。

## ネットワーク環境について
本教科書での実習ではネットワークを利用します。ネットワークの設定項目は複数ありますので、あらかじめ別紙「確認シート」を作成した上で設定を行いましょう。

利用するネットワークの各種設定情報が組織のネットワーク管理担当者から指示されている場合は、その内容を「確認シート」に記述します。本教科書では特定のIPアドレスを用いて設定しますが、それを適宜指示された内容に読み替えてください。

ネットワークを自由に設定できる場合は、本教科書で用いているネットワークの設定を利用して下さい。本教科書では、ネットワーク環境としてコンピューター実習教室を想定しています。教室にはPCが3台以上あり、講師用PCが1台と受講生用PCが2台以上あるとします。ネットワークは、講師用、受講生用PCの区別無く、すべてのPCが1つのネットワークに接続されていることを想定しています。

### ネットワークの設定項目
#### ドメイン名  
ドメイン名は、DNSサーバーを設定するときに必要になります。受講生同士が同じドメイン名にならなければ、各自自由なドメイン名をつけてかまいません。
このドメイン名は、あくまでこのネットワーク内のみで有効なドメイン名で、外部のDNSとは隔離された状態にあります。本教科書では、受講生用にalpha.jpとbeta.jpの2つを使用します。

#### ホスト名  
自分のPCに設定するホスト名です。今回はhost＋受講生番号+ドメイン名とします。確認のため「確認シート」に記述します。

#### IPアドレス  
IPアドレスは、PCのIPアドレスです。本教科書では、講師用PCのIPアドレスを192.168.1.10、受講生用PCのIPアドレスを192.168.1.101と192.168.1.102としています。

#### サブネットマスク  
サブネットマスクは、IPアドレスのネットワーク部とホスト部を分ける値です。本教科書では255.255.255.0(/24)とします。

#### ネットワークアドレス  
ネットワークアドレスは、PCが含まれているネットワーク全体を示すアドレスです。本教科書では192.168.1.0とします。

#### デフォルトゲートウエイ  
異なるサブネットとの通信に必要な値です。本教科書では192.168.1.1とします。

#### DNSサーバーアドレス  
ホスト名とIPアドレスの対応を解決する、DNS（ドメインネームシステム）という機構があります。DNSを利用するためにはDNSサーバーのIPアドレスが必要です。
本教科書では4章で、実際にDNSサーバーを設定し動作させます。実習ではまず自分自身で動作させているDNSサーバーを参照するため、DNSサーバーアドレスを自分のIPアドレスとします。

## 高度なストレージ管理
ここでは、高度なストレージ管理としてLVM(Logical Volume Manager)とRAID(Redundant Arrays of Inexpensive Disks)について説明します。インストールを開始すると、LVMの設定が施されるところがあり、それについての説明です。少々高度な内容になるため、インストール作業後に読んでもかまいません。

### LVM
Logical Volume Manager（LVM）という機構は、一言で言えば「ディスク管理操作を非常に便利にしてくれる機構」と言えます。
ハードディスクを利用する際には、いくつかの「パーティション」に分割します。Windowsのみならず、Linuxでもパーティションを分割する作業を行います。
パーティション分割作業は、容量を決めるのに非常に困難が伴います。「思ったより利用が多く、足りなくなってしまった」「念のため多めにパーティションを割り当てたら、あまり利用されず、大半が未使用になってしまった」といった具合です。
だからといって、パーティションを再分割することは非常に手間がかかります。ハードディスクの内容を、一度全部消してしまうからです。再度インストール作業を行なった後、設定を行いデータを復元する作業は、相当な時間や手間を使います。
LVMを用いると、パーティションを柔軟に取り扱うことができます。

### LVMの仕組み
LVMの仕組みは、次のようになっています。

![LVMの仕組み](image/1LVM.jpg){width=50%}

#### PV(Physical Volume)  
ディスクの物理領域です。パーティションの1区画であったり、ディスク1台丸ごとPVということもありえます。

#### VG(Volume Group) 
一つ以上のPVの集まりがVolume Groupです。

#### LV(Logical Volume) 
VGから、LV領域を切り出して利用します。LVは自由に容量を増やしたり減らしたりできます。LVの容量の合計が、切り出し元のVGより大きくなることはありません。
LVの領域にファイルシステムを作成して、ファイルやディレクトリなどのデータが格納されます。

### LVMの利点
LVMを用いると、どんな点が便利なのでしょうか?実際にケーススタディで学習してみましょう。

#### ディスク領域が不足した場合にディスク容量の増加が容易 
LVに保存したデータが増加し、割り当てたLVの容量では足りなくなった場合は、LVの大きさを増やすことで対応可能です。使用しているファイルシステムによっては、OSを止めることなく容量を増やすこともできます。逆にLVを大きく切り出しすぎて余ってしまった場合には、ファイルシステムを縮めた後にLVを小さくします。これでVGの未使用領域が増えるので、他のLVを増やしたり、新しくLVを切り出したりするときに利用できます。

#### ハードディスクを増設するのも容易 
LVの利用率も増え、その元であるVGの空き容量が少なくなったとします。そのときは、ハードディスクを増設しますが、LVMを用いると作業は簡単です。ハードディスクを取り付けて、そのハードディスクをPVとします。そのPVをVGに追加すると、VG全体の容量が増えます。増えたVGから新しくLVを切り出したり、既存のLVのサイズを増やしたりすることに利用できる領域を増やすことができます。

## RAID
### RAIDとは
RAIDとはRedundant Arrays of Inexpensive Disks の略で、ディスクの耐障害性を高めたり、機能を高めたりすることに用いられます。ディスクのアクセス性能を上げたい場合や、重要なデータを置いておく場合に利用します。

### RAIDの種類
RAIDにはその機能でさまざまな種類があります。ここでは広く用いられるRAID 0,1,5,6,1+0について説明します。

#### RAID 0(ストライピング) 
2台以上のディスクを用意し、書き込み時にそれぞれのディスクに分散書き込みを行います。ディスクの処理が分散するので、読み書きの速度が高速になります。また、使用できるディスク容量はすべてのディスクの容量の合計となります。
欠点は、1台でもディスクが壊れるとすべてのデータが読み書きできなくなることです。

#### RAID 1(ミラーリング) 
ディスクを2台用意し、それぞれに同じ内容を書き込みます。一方のディスクが壊れても、もう一方のディスクが正常であればデータは失われません。そのため、ディスク障害に強い構成を実現できます。
欠点は、利用できる容量が総容量の半分になってしまうことです。例えば容量500GBのディスクを2台用意しても、使用できる容量は500GBのままです。

#### RAID 5(パリティ分散) 
ディスクを3台以上用意し、パリティという特別な仕組みを一緒に書き込むことでディスクの冗長化を図っています。ディスクが1台故障してもデータを失うことはありません。
RAID 5は1台あたりのディスク容量　×　(台数-1)の容量が使えますので、ディスクの利用効率も良いことになります。たとえば500GBのディスクを3台用意すれば、合計1TBのディスク容量になります。
欠点は、データ書き込み時のパリティ計算の負荷が高いため書き込み性能が高くないことや、故障に耐えられるディスクが1台までなので、運悪く2台以上同時に壊れると元データの復元ができないといった点が挙げられます。

#### RAID 6 （複数分散パリティ）
パリティを2重に計算し書き込むことで、ディスクが2台まで故障しても大丈夫にしたRAID構成です。欠点は、より高度なパリティ計算を高速に行うために専用のハードウェアが必要となる点です。

#### RAID1+0 （ミラーリング＋ストライピング）
RAID 1+0はミラーリング(RAID 1)したディスクをストライピング(RAID 0)するRAIDの構成です。ストライピングはディスクが1台でも壊れるとすべてのデータが失われてしまいますが、RAID 1+0ではミラーリングが行われているので、ディスクが1台壊れてもデータは失われません。ただし、ミラーリングされた両方のディスクが壊れてしまうと、通常のRAID 0と同様にデータは失われてしまいます。
欠点は、ディスクが最低でも4台必要であることと、ミラーリングされているため容量が半分になってしまうという点です。

#### その他のRAID 
RAIDには、他にも2,3,4がありますが、あまり使われていません。

### ハードウェアRAIDとソフトウェアRAID
RAIDではハードウェアRAIDとソフトウェアRAIDが存在します。

#### ハードウェアRAID 
ハードウェアRAIDは、RAIDの処理をハードウェアが行います。従って、OS、マザーボード側から見ると、ディスクが1台存在しているように見えるだけです。RAIDコントローラはOS、マザーボードにディスクが1台と「見せかけながら」、その背後でRAIDの処理を行っています。
ハードウェアRAIDを使う利点は、OSは一般的なハードディスクとして認識されるために特別なドライバーを導入する必要がないことと、OSやハードウェアに負荷がかからないことです。欠点として特別なハードウェア（RAIDコントローラ）が必要であるため、費用がかかる点が挙げられます。

#### ソフトウェアRAID 
ソフトウェアRAIDは、OSやドライバーがRAID作業を行います。ソフトウェアRAIDは特別なハードウェア（RAIDコントローラ）が必要ではないため、コストを抑えてRAIDを組むことができますが、欠点としてOSの対応やドライバーの対応が必要であることや、ハードウェアRAIDと比べてOS、ハードウェア（特にCPU）に負荷がかかる点が挙げられます。

###  高度なストレージの利用
高度なストレージとして、LVMとRAIDを紹介しました。ではどのような場面で利用するのが好ましいでしょうか？

Linuxでは（後に紹介しますが）、ディスクを使用するためにパーティションに対して特定のディレクトリをマウントさせます。デフォルトの構成ではパーティションが一つ作成され、そこにすべてのディレクトリの大元となるルートディレクトリ（”/”）がマウントされ、そのサブディレクトリとして/varや/homeといったディレクトリが作成されます。

/varには、ログファイルなどシステムが様々なデータを書き出します。/homeは、ユーザーが作成したデータが置かれます。この2つのディレクトリは非常に重要であり、なおかつ利用量が非常に変化しやすいディレクトリなので、このようなディレクトリはパーティションを分け、ルートディレクトリと切り離してマウントし、そのパーティションをLVMを用いて可変としたり、RAIDを用いて冗長化されるよう構成することが望ましいと言えます。
